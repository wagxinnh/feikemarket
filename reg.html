<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>飞科商城--注册会员</title>
		<link rel="stylesheet" href="css/iconfont.css">
		<link rel="stylesheet" href="css/reg.css">
	</head>
	<body>
		<!-- header -->
		<div class="mainheader">
			<div class="header">
				<div class="headerleft">
					<a href="#">收藏</a>
					<a href="#">微信<img class="wxin" src="img/mainimg/weixin.jpg" alt=""></a>
				</div>
				<div class="headerright">
					<a href="login.html" target="_blank" class="login">登录</a>
					<span>|</span>
					<a href="reg.html" target="_blank" class="regs">注册</a>
				</div>
			</div>
		</div>
		<div class="searchHeader">
			<div class="log">
				<a href="#"><img src="img/mainimg/logo.gif" alt=""></a>
				<a href="index.html"><span>首页</span></a>
			</div>
			<div class="search">
				<form class="clearfix">
					<input type="text" id='search_box' promptvalue="剃须刀" value="剃须刀" />
					<div class="hot_words">
						<a href="javascript:void(0)" class="in_b" onclick="return search_goods('/list_goods/search','剃须刀');">剃须刀</a>
						<a href="javascript:void(0)" class="in_b" onclick="return search_goods('/list_goods/search','电吹风');">电吹风</a>
					</div>
				</form>
				<a class="searchlogo" href="#"></a>
				<a href="#" class="cart">
					<span class="icon iconfont icon-gouwuche"></span>
					<span class="catalt">购物车（<b>0</b>）</span>
					<div class="connect"></div>
					<div class="cartcontent">
						<div class="cartinfo">
							<p>共计<span>0</span>件商品</p>
							<p>合计:<span>0</span>元</p>
						</div>
						<div class="columprice" href="">去购物车结算</div>
					</div>
				</a>
			</div>
		</div>
		<!-- content -->
		<div class="regnews">
			<p class="welcomereg">欢迎注册飞科商城</p>
			<div class="userlogininfo">
				<span><img src="img/icon/user-code.png"></span>
				<input type="text" class="checksinput" placeholder="请输入验证码" maxlength="4" autocomplete="off" οninput="if(value.length>11)value=value.slice(0,11)" onKeyUp="value=value.replace(/[\W]/g,'')" />
				<div class="checkpwd">
					<span><img class="pwdimg"></span>
					<span class="getpwd">换一张</span>
				</div>
			</div>
			<span class="checknews"></span>
			<div class="userlogininfo">
				<span><img src="img/icon/user-id.png"></span>
				<input type="text" class="checksinput" placeholder="请输入手机号！" maxlength="11" oninput="value=value.replace(/[^\d]/g,'')">
				<a class="getautopwd">获取动态验证码</a>
			</div>
			<span class="checknews"></span>
			<div class="userlogininfo">
				<span><img src="img/icon/user-mcode.png"></span>
				<input type="text" class="checksinput" maxlength="6" placeholder="请输入手机验证码">
			</div>
			<span class="checknews"></span>
			<div class="userlogininfo">
				<span><img src="img/icon/user-pwd.png"></span><input type="text" class="checksinput" maxlength="16" placeholder="请输入密码">
			</div>
			<span class="checknews"></span>
			<div class="userlogininfo">
				<span><img src="img/icon/user-pwd.png"></span><input type="text" class="checksinput" maxlength="16" placeholder="请输入密码">
			</div>
			<span class="checknews"></span>
			<p class="regrule">《飞科商城用户服务协议》</p>
			<p class="logins">同意协议并注册</p>
			<span id="msg"></span>
		</div>
		<!-- info -->
		<div class="footmain">
			<div class="info">
				<span>领导品牌&nbsp品质保证</span>
				<span>7天退货&nbsp15天换货</span>
				<span>全场免运费（部分配件除外）</span>
				<span>全国网点&nbsp联保服务</span>
			</div>
			<!-- news -->
			<div class="news">
				<div class="newslist">
					<h3>购物服务</h3>
					<a href="#">购物指南</a>
					<a href="#">配送方式</a>
					<a href="#">支付方式</a>
				</div>
				<div class="newslist">
					<h3>服务支持</h3>
					<a href="#">售后网点</a>
					<a href="#">积分规则</a>
					<a href="#">保修政策</a>
				</div>
				<div class="newslist">
					<h3>关注我们</h3>
					<a href="#">新浪微博</a>
					<a href="#">关注微信</a>
					<a href="#">APP下载</a>
				</div>
				<div class="newslist">
					<h3>关于飞科</h3>
					<a href="#">飞科介绍</a>
					<a href="#">飞科新闻</a>
					<a href="#">联系我们</a>
				</div>
				<div class="ewm">
					<img class="wxcode" src="img/mainimg/qr_code.jpg">
					<p>关注飞科电器官方微信</p>
				</div>
				<img class="call" src="img/mainimg/service1.png">
			</div>
			<!-- footer -->
			<div class="footer">
				<img class="flogo" src="img/mainimg/minilogo.jpg">
				<div class="text">
					<span>Copyright&#169;2013-2016上海飞科电器股份有限公司<span> | </span>版权所有<span> | </span>
						<a href="#">网站备案/许可证号：沪ICP备13041208号</a>
						<a href="#">增值电信营业经营许可认证:沪B2-20160083</a><span>|</span>
						<a href="#" class="lasttext">沪公网安备 31010502001341号</a>
				</div>
				<div class="parter">
					<a href="#"><img src="img/mainimg/rightimg1.jpg"></a><span>|</span>
					<a href="#"><img src="img/mainimg/rightimg2.jpg"></a><span>|</span>
					<a href="#"><img src="img/mainimg/rightimg3.jpg"></a><span>|</span>
					<a href="#"><img src="img/mainimg/rightimg4.jpg"></a>
				</div>
			</div>
			<!-- //固定栏广告 -->
			<div class="adbox">
				<a href="#"><img src="img/mainimg/tglx.jpg" alt="团购客户请QQ联系" title="团购客户请QQ联系"></a>
				<a href="#"><img src="img/mainimg/zxfw.jpg"></a>
			</div>

	</body>
	</div>
</html>
<script>
	window.onload = function() {
		var rnd = Math.ceil(Math.random() * 6);
		// console.log(rnd);
		$(".pwdimg")[0].src = "img/icon/do_index" + rnd + ".gif";
		var inputs = $(".checksinput");
		var ospan = $(".checknews");

		var arr = [3793, 8793, 7340,5550, 1733, 3128, 7191];
		$(".getpwd")[0].onclick=function(){
			rnd=Math.ceil(Math.random()*6);
			console.log(rnd);
			$(".pwdimg")[0].src="img/icon/do_index"+rnd+".gif";
		}
		$(".pwdimg")[0].onclick=function(){
			rnd=Math.ceil(Math.random()*6);
			this.src="img/icon/do_index"+rnd+".gif";
		}
		
		// 验证码
		var flagcheckpwd = false;
		inputs[0].onblur= function() {
			if(!this.value.trim()){
				ospan[0].innerHTML ="验证码不能为空";
				this.value='';
				this.focus();
			}else{
				if (this.value == arr[rnd]) {
					flagcheckpwd = true;
					ospan[0].innerHTML = "";
				} else {
					ospan[0].innerHTML = "请输入正确的验证码";
				}
			}
		}
		//手机号
		var flagphone = false;
		inputs[1].onblur= function() {
			if(!this.value.trim()){
				ospan[1].innerHTML ="手机号不能为空";
				this.value='';
				this.focus();
			}else{
				var r = /^1[3-9]\d{9}$/;
				if (r.test(this.value) == true) {
					afterCheckUser((has)=>{
						if(has){
							ospan[1].innerHTML= "用户名已经注册";
						}else{
							ospan[1].innerHTML= "";
							$(".getautopwd")[0].style.backgroundColor = "#0c82d9";
							$(".getautopwd")[0].style.color = "#ffffff";
							ospan[1].innerHTML = "";
							flagphone = true;
						}
					});//后端验证
				} else {
					$(".getautopwd")[0].style.backgroundColor = "";
					ospan[1].innerHTML = "请正确填写您的手机号码";
				}
			}
		}
		//动态码
		var autostr = "456123";
		var flagautopwd = false;
		inputs[2].onblur = function() {
			if(!this.value.trim()){
				ospan[2].innerHTML ="动态码不能为空";
				this.value='';
				this.focus();
			}else{
				if (this.value == autostr) {
					flagautopwd = true;
					ospan[2].innerHTML = "";
				} else {
					ospan[2].innerHTML = "请输入正确的验证码";
				}
			}
		}
		// 密码
		var flagpws = false;
		inputs[3].onblur = function() {
			if(!this.value.trim()){
				ospan[3].innerHTML ="密码不能为空";
				this.value='';
				this.focus();
			}else{
				var userpass = /^\w{6,16}$/;
				if (userpass.test(this.value) == true) {
					ospan[3].innerHTML = "";
					flagpws = true;
				} else {
					ospan[3].innerHTML = "密码不能小于六位数";
				}
			}
		}

		//重复密码的验证
		var flagrepws = false;
		inputs[4].onblur = function() {
			if(!this.value.trim()){
				ospan[3].innerHTML ="密码不能为空";
				this.value='';
				this.focus();
			}else{
				if (checkpass()) {
					ospan[4].innerHTML = "";
					flagrepws = true;
				} else {
					ospan[4].innerHTML = "两次密码输入不一样";
				}
			}
		}
		//重复密码的验证
		function checkpass() {
			return inputs[3].value == inputs[4].value;
		}
		//前端验证
		function frontCheck() {
			if (!flagcheckpwd || !flagphone || !flagautopwd || !flagpws || !flagrepws) {
				return false;
			}
			return true;
		}
		
		//注册按钮绑定事件
		$(".logins")[0].onclick = function() {
			//1、先看前端验证是否全部通过
			if (!frontCheck() || !checkpass()) {
				alert("亲，请把信息输入正确!");
				return;
			}
			//2、手机号是否存在
			if (isExistsUser) {
				ospan[1].innerHTML ="亲，此手机号已注册";
				return;
			}
			//2、后端注册
			regSave();
		}

		//用户名是否存在
		var isExistsUser = false;
		//后端验证用户名是否存在
		function afterCheckUser(func) {
			//1、创建对象
			let xhr = new XMLHttpRequest();
			//2、设置请求参数
			let sendstr = "userphone=" +inputs[1].value;
			xhr.open("get", "php/checkuser.php?" + sendstr, true);

			//3、设置回调函数
			xhr.onreadystatechange = () => {
				if (xhr.readyState == 4 && xhr.status == 200) {
					isExistsUser = xhr.responseText == 1 ? true : false;
					// console.log(isExistsUser);
					func(isExistsUser);
				}
			}
			//4、发送请求
			xhr.send();
		}
 		//后端注册
		function regSave() {
			//1、创建对象
			let xhr = new XMLHttpRequest();
			//2、设置请求参数
			xhr.open("post", "php/regSave.php", true);
			//3、设置回调函数 
			xhr.onreadystatechange = function() {
				if (xhr.readyState == 4 && xhr.status == 200) {
					console.log(xhr.responseText);
					if (xhr.responseText == 1) {
						alert("亲，恭喜您，注册成功！跳转到登录页面");
						location.href="login.html";
					} else {
						alert("亲，不好意思，注册失败！请重新输入内容");
					}
				}
			}
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			//2)、把发送的数据作为send函数的参数
			let sendstr = `userphone=${inputs[1].value}&userpass=${inputs[3].value}`;
			xhr.send(sendstr);
			}
			
			$(".columprice")[0].onclick=function(){
				location.href="shoppingcart.html";
			}
			
			function $(str) {
				if (str.charAt(0) == "#") {
					return document.getElementById(str.substring(1));
				} else if (str.charAt(0) == ".") {
					return document.getElementsByClassName(str.substring(1));
				} else {
					return document.getElementsByTagName(str);
				}
			}
	}
</script>
